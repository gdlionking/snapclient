name: build-snapclient-android

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK: /home/runner/ndk/ndk
      ANDROID_SDK_ROOT: /home/runner/Android/Sdk
      ANDROID_API: 33
      ANDROID_ABI: arm64-v8a

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build clang pkg-config git unzip wget

    - name: Setup Android SDK
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
        yes | $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/bin/sdkmanager --licenses
        $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/bin/sdkmanager "platform-tools" "platforms;android-$ANDROID_API"

    - name: Clone and build Oboe
      run: |
        git clone https://github.com/google/oboe.git
        mkdir -p oboe/build && cd oboe/build
        cmake .. -G Ninja \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_BUILD_TYPE=Release
        ninja
        cd ../../
        echo "OBEO_DIR=$(pwd)/oboe/build" >> $GITHUB_ENV

    - name: Build Snapclient Android
      run: |
        mkdir -p snapclient/build-android && cd snapclient/build-android
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=$ANDROID_ABI \
          -DANDROID_PLATFORM=android-$ANDROID_API \
          -DCMAKE_PREFIX_PATH=$OBEO_DIR
        cmake --build . -- -j$(nproc)

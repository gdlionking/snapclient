name: Build Playerctl for Armbian

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set NDK Path
        run: |
          export TOOLCHAIN=$HOME/ndk/toolchains/llvm/prebuilt/linux-x86_64
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git autoconf automake libtool pkg-config ninja-build meson

      - name: Download Android NDK r26d
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip -d $HOME
          mv $HOME/android-ndk-r26d $HOME/ndk

      - name: Clone playerctl
        run: |
          git clone https://github.com/altdesktop/playerctl.git
          cd playerctl
          git submodule update --init --recursive

      - name: Build playerctl (armv7)
        run: |
          cd playerctl
          export CC="$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang"
          export CXX="$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++"
          export AR="$TOOLCHAIN/bin/llvm-ar"
          export LD="$TOOLCHAIN/bin/ld.lld"

          meson setup builddir \
            --cross-file ../cross-file.txt \
            --default-library=static

          ninja -C builddir
          mkdir -p ../output
          cp builddir/playerctl ../output/playerctl-armv7

      - name: Create Release
        run: |
          tag="build-$(date +'%Y%m%d-%H%M%S')"
          gh release create "$tag" -t "Playerctl Build $tag" -n "自动构建的 Playerctl"

      - name: Upload Build to Release
        run: |
          tag=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          gh release upload "$tag" output/playerctl-armv7

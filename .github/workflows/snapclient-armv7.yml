name: Build Termux snapclient (armv7)

on:
  # 允许手动触发工作流
  workflow_dispatch:

jobs:
  build-armv7:
    runs-on: ubuntu-latest
    env:
      NDK_VER: r26d
      ANDROID_API: 24
      ANDROID_ABI: armeabi-v7a
      OPENSSL_VER: 1.1.1w
      # 定义 OBOE 库的安装根目录
      OBOE_INSTALL_DIR: ${{ runner.temp }}/oboe-install

    steps:
    - name: 1. Checkout snapcast (v0.34.0)
      uses: actions/checkout@v4
      with:
        repository: badaix/snapcast
        ref: v0.34.0
        path: snapcast

    - name: 2. Install host dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build git wget unzip build-essential python3-pip pkg-config
        pip3 install meson

    - name: 3. Download Android NDK (${{ env.NDK_VER }})
      run: |
        wget https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VER }}-linux.zip -O ndk.zip
        unzip ndk.zip
        mv android-ndk-${{ env.NDK_VER }} $HOME/ndk
        echo "NDK installed to $HOME/ndk"

    - name: 4. Cross-build and Install OpenSSL (static)
      run: |
        set -e
        cd $RUNNER_TEMP
        wget https://www.openssl.org/source/openssl-${{ env.OPENSSL_VER }}.tar.gz
        tar xf openssl-${{ env.OPENSSL_VER }}.tar.gz
        cd openssl-${{ env.OPENSSL_VER }}
        export ANDROID_NDK_HOME=$HOME/ndk
        export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        ./Configure android-arm -D__ANDROID_API__=${{ env.ANDROID_API }} no-shared --prefix=$HOME/openssl
        make -j$(nproc)
        make install_sw
        echo "OpenSSL installed to $HOME/openssl"

    - name: 5. Cross-build and Install Oboe
      run: |
        set -e
        # OBOE_INSTALL_DIR 位于 /home/runner/work/snapclient/snapclient/oboe_install (或类似路径)
        export OBOE_INSTALL_DIR=${{ env.OBOE_INSTALL_DIR }} 
        git clone https://github.com/google/oboe.git oboe
        cd oboe
        mkdir -p build && cd build
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ env.ANDROID_ABI }} \
          -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DOBE_BUILD_TESTS=OFF \
          -DCMAKE_INSTALL_PREFIX=${OBOE_INSTALL_DIR}
        
        ninja -j$(nproc)
        ninja install 

        echo "Oboe installed to ${OBOE_INSTALL_DIR}"
        # ⚠️ 移除 OboeConfig.cmake 的检查，避免工作流因 Oboe 缺乏配置包而失败

    - name: 6. Configure and build snapclient (Android armv7)
      working-directory: snapcast
      run: |
        set -e
        export OBOE_INSTALL_DIR=${{ env.OBOE_INSTALL_DIR }}
        mkdir -p build-android
        cd build-android
        echo "Starting CMake configuration..."
        
        # OBOE 静态库路径: /home/runner/oboe-install/lib/armeabi-v7a/liboboe.a
        OBOE_LIB_PATH="${OBOE_INSTALL_DIR}/lib/${{ env.ANDROID_ABI }}/liboboe.a"
        
        cmake -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ env.ANDROID_ABI }} \
          -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_CLIENT=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_TESTS=OFF \
          # OpenSSL 配置
          -DOPENSSL_ROOT_DIR=$HOME/openssl \
          -DOPENSSL_INCLUDE_DIR=$HOME/openssl/include \
          -DOPENSSL_CRYPTO_LIBRARY=$HOME/openssl/lib/libcrypto.a \
          -DOPENSSL_SSL_LIBRARY=$HOME/openssl/lib/libssl.a \
          # Oboe 配置：直接指定 Snapclient 内部变量
          -DENABLE_OBOE=ON \
          -DOBOE_INCLUDE_DIR="${OBOE_INSTALL_DIR}/include" \
          -DOBOE_LIBRARY="${OBOE_LIB_PATH}" \
          -DENABLE_OPENSLES=ON \
          -DENABLE_PULSE=OFF \
          -DENABLE_ALSA=OFF \
          -DENABLE_AVAHI=OFF \
          ..
        
        echo "Starting Ninja build for snapclient..."
        # 明确编译目标名称：snapclient
        ninja snapclient -j$(nproc)
        echo "Build finished."

    - name: 7. Show artifact file and check existence (Debug)
      id: check_artifact
      run: |
        ARTIFACT_PATH=snapcast/build-android/client/snapclient
        echo "Built files list:"
        ls -la snapcast/build-android/client || true
        
        if [ ! -f "$ARTIFACT_PATH" ]; then
          echo "::error file=$ARTIFACT_PATH::Snapclient binary not found at $ARTIFACT_PATH. The build failed silently."
          exit 1
        fi
        
        echo "Snapclient binary successfully created."
        file "$ARTIFACT_PATH"

    - name: 8. Upload snapclient artifact
      uses: actions/upload-artifact@v4
      with:
        name: snapclient-armv7-termux
        path: snapcast/build-android/client/snapclient

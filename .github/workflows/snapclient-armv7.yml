name: Build Snapclient Android

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_HOME: ${{ github.workspace }}/ndk
      ANDROID_ABI: armeabi-v7a
      ANDROID_PLATFORM: android-24
      BUILD_CLIENT: ON
      BUILD_SERVER: OFF
      BUILD_TESTS: OFF

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build git wget unzip pkg-config build-essential

    - name: Download Android NDK
      run: |
        mkdir -p $ANDROID_NDK_HOME
        cd $ANDROID_NDK_HOME
        wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip android-ndk-r25b-linux.zip
        mv android-ndk-r25b/* .
        rm -rf android-ndk-r25b android-ndk-r25b-linux.zip

    - name: Clone Oboe
      run: |
        git clone https://github.com/google/oboe.git
        mkdir -p oboe/build
        cd oboe/build
        cmake .. -G Ninja
        ninja

    - name: Build Snapclient Android
      run: |
        mkdir -p snapclient/build-android
        cd snapclient/build-android
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=$ANDROID_ABI \
          -DANDROID_PLATFORM=$ANDROID_PLATFORM \
          -DBUILD_CLIENT=$BUILD_CLIENT \
          -DBUILD_SERVER=$BUILD_SERVER \
          -DBUILD_TESTS=$BUILD_TESTS \
          -Doboe_DIR=${{ github.workspace }}/oboe/build/oboe
        cmake --build . --config Release

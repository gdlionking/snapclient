name: Build Termux snapclient (armv7)

on:
  workflow_dispatch:

jobs:
  build-armv7:
    runs-on: ubuntu-latest
    env:
      NDK_VER: r26d
      ANDROID_API: 24
      ANDROID_ABI: armeabi-v7a
      OPENSSL_VER: 1.1.1w
      # OBOE_INSTALL_DIR 定义被移除，将在步骤中作为 shell 变量或硬编码路径使用
      
    steps:
    - name: Checkout snapcast (v0.34.0)
      uses: actions/checkout@v4
      with:
        repository: badaix/snapcast
        ref: v0.34.0
        path: snapcast

---

    - name: Install host deps
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build git wget unzip build-essential python3-pip pkg-config
        pip3 install meson

    - name: Download Android NDK (${{ env.NDK_VER }})
      run: |
        wget https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VER }}-linux.zip -O ndk.zip
        unzip ndk.zip
        mv android-ndk-${{ env.NDK_VER }} $HOME/ndk
        echo "NDK installed to $HOME/ndk"

    - name: Cross-build OpenSSL (static) for armeabi-v7a
      run: |
        set -e
        # OpenSSL 安装到 $HOME/openssl
        cd $RUNNER_TEMP
        wget https://www.openssl.org/source/openssl-${{ env.OPENSSL_VER }}.tar.gz
        tar xf openssl-${{ env.OPENSSL_VER }}.tar.gz
        cd openssl-${{ env.OPENSSL_VER }}
        export ANDROID_NDK_HOME=$HOME/ndk
        export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        ./Configure android-arm -D__ANDROID_API__=${{ env.ANDROID_API }} no-shared --prefix=$HOME/openssl
        make -j$(nproc)
        make install_sw

---

    - name: Cross-build and Install Oboe
      run: |
        set -e
        # ⚠️ 将 OBOE 安装目录硬编码到 $HOME/oboe-install
        export OBOE_INSTALL_DIR=$HOME/oboe-install 
        git clone https://github.com/google/oboe.git oboe
        cd oboe
        mkdir -p build && cd build
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ env.ANDROID_ABI }} \
          -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DOBE_BUILD_TESTS=OFF \
          -DCMAKE_INSTALL_PREFIX=${OBOE_INSTALL_DIR} # <-- 使用 shell 变量
        
        ninja -j$(nproc)
        ninja install 

        ls -la ${OBOE_INSTALL_DIR}/lib/cmake/oboe/oboeConfig.cmake

---

    - name: Configure and build snapclient (Android armv7)
      working-directory: snapcast
      run: |
        set -e
        # ⚠️ 在此重新定义 OBOE 安装目录
        export OBOE_INSTALL_DIR=$HOME/oboe-install 
        mkdir -p build-android
        cd build-android
        cmake -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ env.ANDROID_ABI }} \
          -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_CLIENT=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_TESTS=OFF \
          -DOPENSSL_ROOT_DIR=$HOME/openssl \
          -DOPENSSL_INCLUDE_DIR=$HOME/openssl/include \
          -DOPENSSL_CRYPTO_LIBRARY=$HOME/openssl/lib/libcrypto.a \
          -DOPENSSL_SSL_LIBRARY=$HOME/openssl/lib/libssl.a \
          -DCMAKE_PREFIX_PATH="${OBOE_INSTALL_DIR}" \
          -DENABLE_OBOE=ON \
          -DENABLE_OPENSLES=ON \
          -DENABLE_PULSE=OFF \
          -DENABLE_ALSA=OFF \
          -DENABLE_AVAHI=OFF \
          ..
        ninja client -j$(nproc)

---

    - name: Show artifact file
      run: |
        echo "Built files:"
        ls -la snapcast/build-android/client || true
        file snapcast/build-android/client/snapclient || true

    - name: Upload snapclient artifact
      uses: actions/upload-artifact@v4
      with:
        name: snapclient-armv7-termux
        path: snapcast/build-android/client/snapclient

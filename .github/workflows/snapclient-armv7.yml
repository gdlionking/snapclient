name: Build Snapclient for Termux ARMv7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          repository: badaix/snapcast
          ref: v0.34.0

      - name: Setup Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip android-ndk-r25b-linux.zip
          mv android-ndk-r25b $HOME/android-ndk

      - name: Configure CMake (disable Oboe, enable libao)
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_ANDROID_NDK=$HOME/android-ndk \
            -DCMAKE_ANDROID_ARCH_ABI=armeabi-v7a \
            -DCMAKE_ANDROID_API=21 \
            -DBUILD_CLIENT=ON \
            -DBUILD_SERVER=OFF \
            -DUSE_LIBAO=ON \
            -DUSE_OBSOE=OFF

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Package
        run: |
          cd build
          tar czf snapclient-armv7l.tar.gz snapclient
          mkdir -p $GITHUB_WORKSPACE/artifacts
          mv snapclient-armv7l.tar.gz $GITHUB_WORKSPACE/artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: snapclient-armv7l
          path: artifacts/snapclient-armv7l.tar.gz

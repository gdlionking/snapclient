name: Build Termux Snapclient ARMv7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout snapclient source
        uses: actions/checkout@v4
        with:
          repository: snapcast/snapcast
          ref: v0.34.0

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ninja-build python3-pip git wget unzip
          pip3 install meson

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          mv android-ndk-r26d $HOME/ndk

      - name: Download Oboe
        run: |
          git clone https://github.com/google/oboe.git
          cd oboe
          git checkout 1.7.0
          mkdir build && cd build
          cmake -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/build/cmake/android.toolchain.cmake \
                -DANDROID_PLATFORM=21 \
                -DANDROID_ABI=armeabi-v7a \
                -DCMAKE_BUILD_TYPE=Release \
                -DOBE_BUILD_TESTS=OFF \
                ..
          cmake --build .
          sudo cmake --install . --prefix /usr/local

      - name: Build snapclient
        run: |
          mkdir build-android
          cd build-android
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/build/cmake/android.toolchain.cmake \
            -DANDROID_PLATFORM=21 \
            -DANDROID_ABI=armeabi-v7a \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_CLIENT=ON \
            -DBUILD_SERVER=OFF \
            -DWITH_OGG=ON \
            -DWITH_OPUS=ON \
            -DWITH_FLAC=ON \
            -DWITH_ALSA=OFF \
            -DWITH_PULSEAUDIO=OFF \
            -DWITH_OBSOLETE_LIBSNDFILE=OFF \
            ..
          cmake --build . --target snapclient -j$(nproc)

      - name: Upload ARMv7 Snapclient
        uses: actions/upload-artifact@v4
        with:
          name: snapclient-armv7
          path: build-android/client/snapclient

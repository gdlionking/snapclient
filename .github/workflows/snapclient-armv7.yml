name: build-snapclient-android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout snapcast
        run: |
          git clone --branch v0.34.0 https://github.com/badaix/snapcast.git
          cd snapcast
          git submodule update --init --recursive

      - name: Download NDK r26d
        run: |
          mkdir -p $HOME/ndk
          cd $HOME/ndk
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          mv android-ndk-r26d ndk

      - name: Clone and build Oboe
        run: |
          git clone https://github.com/google/oboe.git
          cd oboe
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/ndk/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-24
          make -j$(nproc)

      - name: Build snapclient
        run: |
          cd snapcast
          mkdir build-android
          cd build-android

          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/ndk/ndk/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-24 \
            -DBUILD_CLIENT=ON \
            -DBUILD_SERVER=OFF \
            -DBUILD_TESTS=OFF \
            -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/oboe/build;$GITHUB_WORKSPACE/oboe/build/oboe" \
            -Doboe_DIR="$GITHUB_WORKSPACE/oboe/build/oboe"

          make -j$(nproc)

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: snapclient-android-armv7
          path: snapcast/build-android/client/snapclient

name: Snapclient Android ARMv7 Build (GitHub Actions)

on:
  # è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_android_armv7:
    name: Build Snapclient v0.34.0 for Android ARMv7
    # ä½¿ç”¨æ ‡å‡†çš„ Ubuntu è¿è¡Œå™¨ä½œä¸ºå®¿ä¸»æœºå™¨ (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        # å‡è®¾æ‚¨çš„ Snapclient æºç å·²ç»åœ¨è¿™ä¸ªä»“åº“ä¸­ï¼Œæˆ–è€…æˆ‘ä»¬å°†ç›´æ¥ä¸‹è½½ v0.34.0 å‹ç¼©åŒ…
        uses: actions/checkout@v4
        with:
          repository: badaix/snapcast
          ref: v0.34.0 # æŒ‡å®š V0.34.0 æ ‡ç­¾
          path: snapcast-0.34.0

      - name: ğŸ› ï¸ Install Build Dependencies (on Host)
        # å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ autotools å’Œä¾èµ–åº“çš„å®¿ä¸»å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential automake autoconf libtool pkg-config

      - name: âš™ï¸ Setup Android NDK and Toolchain
        # ä½¿ç”¨å®˜æ–¹ action è®¾ç½® Android NDK (è¿™æ˜¯äº¤å‰ç¼–è¯‘çš„å…³é”®)
        uses: android-actions/setup-ndk@v2
        with:
          # æˆ‘ä»¬é’ˆå¯¹çš„æ˜¯ Termuxï¼Œé€šå¸¸å»ºè®®ä½¿ç”¨è¾ƒé«˜çš„ API çº§åˆ«ä»¥è·å¾—æ›´å¥½çš„å…¼å®¹æ€§
          # Termux é€šå¸¸è¿è¡Œåœ¨è¾ƒæ–°çš„ Android ç‰ˆæœ¬ä¸Š
          ndk-version: r26c # ç¨³å®šç‰ˆæœ¬
          api: 21 # Android 5.0 (Lollipop) æ˜¯æ”¯æŒ armv7l çš„æœ€ä½å¸¸ç”¨ç‰ˆæœ¬

      - name: ğŸ” Define Environment Variables for ARMv7
        # è®¾ç½®äº¤å‰ç¼–è¯‘æ‰€éœ€çš„æ‰€æœ‰ç¯å¢ƒå˜é‡
        run: |
          # NDK è·¯å¾„
          export NDK_ROOT="${{ steps.setup-ndk.outputs.ndk-path }}"
          # ç¼–è¯‘ç›®æ ‡æ¶æ„
          export TARGET_ARCH=armv7a-linux-androideabi
          # NDK ç¼–è¯‘å·¥å…·é“¾è·¯å¾„
          export TOOLCHAIN_BIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          # è®¾ç½® C/C++ ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ (ä½¿ç”¨ NDK æä¾›çš„ clang)
          export CC="$TOOLCHAIN_BIN/$TARGET_ARCH$API-clang"
          export CXX="$TOOLCHAIN_BIN/$TARGET_ARCH$API-clang++"
          export AR="$TOOLCHAIN_BIN/llvm-ar"
          export LD="$TOOLCHAIN_BIN/ld"

          # ä¼ é€’ç¯å¢ƒå˜é‡ç»™åç»­æ­¥éª¤
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "LD=$LD" >> $GITHUB_ENV
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "TARGET_ARCH=$TARGET_ARCH" >> $GITHUB_ENV

      - name: â¬‡ï¸ Download and Setup Dependencies (PulseAudio/libsamplerate)
        # å¯¹äº Android NDK äº¤å‰ç¼–è¯‘ï¼ŒPulseAudio åº“ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ Termux ç‰¹æœ‰çš„å®ç°ã€‚
        # ä½† Snapclient å¯ä»¥ç¼–è¯‘æˆä¸å¸¦ PulseAudio æˆ– ALSA ä¾èµ–çš„ç‰ˆæœ¬ï¼Œ
        # ç„¶ååœ¨ Termux ä¸­ä½¿ç”¨ PulseAudio çš„ wrapper æˆ–æ„å»º Termux ç‰¹æœ‰çš„ä¾èµ–ã€‚
        # ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å…ˆç¦ç”¨ PulseAudio/ALSAï¼Œç¡®ä¿æ ¸å¿ƒç¼–è¯‘é€šè¿‡ã€‚
        # ç”¨æˆ·å¯ä»¥åœ¨ Termux ä¸­ä½¿ç”¨ netcat/socat è½¬å‘éŸ³é¢‘æµæˆ–åœ¨ Termux ç¯å¢ƒä¸­è¿›è¡Œæœ¬åœ°ç¼–è¯‘ã€‚

        # ğŸ¯ æ›´æ”¹ç­–ç•¥ï¼šæˆ‘ä»¬æ— æ³•åœ¨ NDK ä¸­äº¤å‰ç¼–è¯‘ PulseAudio ä¾èµ–ã€‚
        # æœ€å…¼å®¹çš„æ–¹å¼æ˜¯ç¼–è¯‘ä¸€ä¸ªä¸å¸¦ PulseAudio çš„æ ¸å¿ƒç‰ˆæœ¬ï¼Œå¹¶ä½¿ç”¨ Termux çš„ PulseAudio Wrapperã€‚
        # æˆ–è€…ä½¿ç”¨ Snapcast æä¾›çš„ Android JNI/JavaAudioTrack ç¼–è¯‘ï¼Œä½†é‚£å¤æ‚å¾—å¤šã€‚
        # æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªæœ€ç®€æ ¸å¿ƒç‰ˆæœ¬ï¼š

        run: |
          # æˆ‘ä»¬åªéœ€è¦ libsamplerate ä¾èµ–
          cd snapcast-0.34.0/client
          wget -O libsamplerate-0.1.9.tar.gz https://github.com/libsndfile/libsamplerate/releases/download/0.1.9/libsamplerate-0.1.9.tar.gz
          tar -xzf libsamplerate-0.1.9.tar.gz
          cd libsamplerate-0.1.9
          ./configure --host=$TARGET_ARCH --prefix=$RUNNER_TEMP/samplerate --disable-shared
          make -j$(nproc)
          make install

      - name: ğŸ”¨ Configure and Build Snapclient
        # å®é™…çš„äº¤å‰ç¼–è¯‘æ­¥éª¤
        run: |
          cd snapcast-0.34.0/client
          
          # 1. è¿è¡Œ autogen.sh (åœ¨ client ç›®å½•ä¸‹å¯èƒ½éœ€è¦)
          autoreconf -i
          
          # 2. é…ç½®ç¼–è¯‘
          # --host: äº¤å‰ç¼–è¯‘çš„ç›®æ ‡å¹³å°
          # --with-pulse=no å’Œ --with-alsa=no ç¦ç”¨å®˜æ–¹ä¾èµ–ï¼Œç¡®ä¿å®ƒèƒ½ç¼–è¯‘
          # --with-libsamplerate é“¾æ¥æˆ‘ä»¬åˆšåˆšç¼–è¯‘çš„é™æ€åº“
          ./configure \
              --host=$TARGET_ARCH \
              --with-pulse=no \
              --with-alsa=no \
              --with-pipewire=no \
              --with-libsamplerate=yes \
              --disable-tests \
              CPPFLAGS="-I$RUNNER_TEMP/samplerate/include" \
              LDFLAGS="-L$RUNNER_TEMP/samplerate/lib"
              
          # 3. ç¼–è¯‘
          make -j$(nproc)

      - name: ğŸ“¤ Archive and Upload Artifact
        # å°†ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ä½œä¸º GitHub Artifact ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: snapclient-armv7l-v0.34.0
          path: snapcast-0.34.0/client/snapclient
          # Termux ç”¨æˆ·ä¸‹è½½åå¯ä»¥ç›´æ¥è¿è¡Œ

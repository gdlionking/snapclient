name: Snapclient Android ARMv7 Build (GitHub Actions)

on:
  # è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_android_armv7:
    name: Build Snapclient v0.34.0 for Android ARMv7
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Snapcast v0.34.0 Source
        # è·å– V0.34.0 æ ‡ç­¾çš„æºç 
        uses: actions/checkout@v4
        with:
          repository: badaix/snapcast
          ref: v0.34.0
          path: snapcast-0.34.0

      - name: ğŸ› ï¸ Install Build Dependencies (on Host)
        # å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ autotools å’Œ pkg-config
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential automake autoconf libtool pkg-config

      - name: âš™ï¸ Setup Android SDK and NDK (FIXED: Using reliable action)
        # ä½¿ç”¨ android-sdk/setup-android è§£å†³ä¸Šä¸€è½® Action ä»“åº“æ‰¾ä¸åˆ°çš„é—®é¢˜
        uses: android-sdk/setup-android@v2
        with:
          # NDK r26c æ˜¯æ‚¨æŒ‡å®šçš„ç¨³å®šç‰ˆæœ¬
          ndk-version: r26c
          # ä½¿ç”¨ API 21 (Android 5.0) å…¼å®¹ armv7l
          android-version: 21

      - name: ğŸ” Define Cross-Compilation Environment Variables
        # è®¾ç½®äº¤å‰ç¼–è¯‘æ‰€éœ€çš„æ‰€æœ‰ç¯å¢ƒå˜é‡
        run: |
          # NDK_ROOT è·¯å¾„ç”± android-sdk/setup-android è‡ªåŠ¨è®¾ç½®åœ¨ ANDROID_NDK_HOME
          export NDK_ROOT="${ANDROID_NDK_HOME}" 
          API=21 
          TARGET_ARCH=armv7a-linux-androideabi
          TOOLCHAIN_BIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          # è®¾ç½® C/C++ ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ (ä½¿ç”¨ NDK æä¾›çš„ clang)
          # æ³¨æ„ï¼šNDK r26c ä½¿ç”¨ $TARGET_ARCH-clang$API çš„å‘½åæ ¼å¼
          export CC="$TOOLCHAIN_BIN/$TARGET_ARCH-clang$API" 
          export CXX="$TOOLCHAIN_BIN/$TARGET_ARCH-clang++$API"
          export AR="$TOOLCHAIN_BIN/llvm-ar"
          export LD="$TOOLCHAIN_BIN/ld"

          # ä¼ é€’ç¯å¢ƒå˜é‡ç»™åç»­æ­¥éª¤
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "LD=$LD" >> $GITHUB_ENV
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "TARGET_ARCH=$TARGET_ARCH" >> $GITHUB_ENV
          
      - name: â¬‡ï¸ Compile libsamplerate Dependency
        # Snapclient ä¾èµ– libsamplerateï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº¤å‰ç¼–è¯‘å®ƒ
        run: |
          cd snapcast-0.34.0/client
          wget -O libsamplerate-0.1.9.tar.gz https://github.com/libsndfile/libsamplerate/releases/download/0.1.9/libsamplerate-0.1.9.tar.gz
          tar -xzf libsamplerate-0.1.9.tar.gz
          cd libsamplerate-0.1.9
          # ä½¿ç”¨ --host è¿›è¡Œäº¤å‰ç¼–è¯‘é…ç½®
          ./configure --host=$TARGET_ARCH --prefix=$RUNNER_TEMP/samplerate --disable-shared
          make -j$(nproc)
          make install

      - name: ğŸ”¨ Configure and Build Snapclient
        # å®é™…çš„ Snapclient äº¤å‰ç¼–è¯‘æ­¥éª¤
        run: |
          cd snapcast-0.34.0/client
          
          # è¿è¡Œ autoconf
          autoreconf -i
          
          # é…ç½®ç¼–è¯‘ï¼Œç¦ç”¨æ‰€æœ‰å®˜æ–¹éŸ³é¢‘åç«¯ï¼Œå¹¶é“¾æ¥ libsamplerate
          ./configure \
              --host=$TARGET_ARCH \
              --with-pulse=no \
              --with-alsa=no \
              --with-pipewire=no \
              --with-libsamplerate=yes \
              --disable-tests \
              CPPFLAGS="-I$RUNNER_TEMP/samplerate/include" \
              LDFLAGS="-L$RUNNER_TEMP/samplerate/lib"
              
          # ç¼–è¯‘
          make -j$(nproc)

      - name: ğŸ“¤ Archive and Upload Artifact
        # å°†ç¼–è¯‘å¥½çš„ snapclient å¯æ‰§è¡Œæ–‡ä»¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapclient-armv7l-v0.34.0
          path: snapcast-0.34.0/client/snapclient
          retention-days: 7 # ä¿ç•™ 7 å¤©
              LDFLAGS="-L$RUNNER_TEMP/samplerate/lib"
              
          # 3. ç¼–è¯‘
          make -j$(nproc)

      - name: ğŸ“¤ Archive and Upload Artifact
        # å°†ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ä½œä¸º GitHub Artifact ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: snapclient-armv7l-v0.34.0
          path: snapcast-0.34.0/client/snapclient
          # Termux ç”¨æˆ·ä¸‹è½½åå¯ä»¥ç›´æ¥è¿è¡Œ
